# Лабораторная работа №8. Локализация

## 1. Цель работы

Целью лабораторной работы является изучение процесса настройки локализации во Flutter-приложении с использованием встроенного механизма `flutter_localizations`. Студенты получат практические навыки добавления поддержки нескольких языков, конфигурации генерации локализованных ресурсов и их использования в пользовательском интерфейсе. Также будет рассмотрен приём работы с `barrel-файлами`.

## 2. Общее описание

Локализация позволяет адаптировать интерфейс приложения под языковые и культурные особенности пользователей. Flutter предоставляет встроенную поддержку локалей на базе пакета `flutter_localizations`, обеспечивая возможность отображения текста, дат и других элементов в соответствии с выбранным языком.

Для организации локализации используется система ключей и языковых ресурсов, описываемых в `.arb`-файлах. Эти ресурсы автоматически преобразуются в доступный для использования код с помощью встроенного генератора, управляемого через файл конфигурации `l10n.yaml`.

Корректная настройка локализации облегчает поддержку многоязычных интерфейсов и является неотъемлемой частью международных приложений. Она также способствует улучшению пользовательского опыта за счёт адаптации контента под язык и регион пользователя.

Дополнительно в работе затрагивается практика использования `barrel-файлов` — файлов с централизованными экспортами, позволяющих сократить и унифицировать импорты по проекту.

## 3. Основная часть

### Обновление `pubspec.yaml`

- Добавим новую зависимость для поддержки локализации:

```yaml
flutter_localizations:
  sdk: flutter
```

- Разрешим автоматическую генерацию файлов локализации:

```yaml
flutter:
  generate: true
```

### Настройка генерации файлов локализации

Для конфигурации генерации локализованных файлов создадим файл `l10n.yaml` в корне проекта. Он определяет, откуда брать `.arb`-файлы и куда генерировать `.dart`-файл с локализованными строками:

```yaml
arb-dir: assets/l10n
template-arb-file: locale_ru.arb
output-localization-file: app_localizations.dart
output-dir: lib/app/gen/l10n
output-class: AppLocalizations
synthetic-package: false
```

- `arb-dir` — путь к директории, где хранятся `.arb`-файлы с переводами;
- `template-arb-file` — основной (базовый) файл, от которого будет строиться структура локализации;
- `output-localization-file` — имя генерируемого `.dart`-файла;
- `output-dir` — директория, в которую будет помещён сгенерированный файл;
- `output-class` — имя класса, через который будет осуществляться доступ к строкам;
- `synthetic-package: false` — отключает использование синтетического пакета, позволяя импортировать файл напрямую из `lib/`.

После настройки `l10n.yaml` и добавления хотя бы одного `.arb`-файла локализация будет автоматически генерироваться при запуске команды `flutter pub get`.

### Создание `.arb`-файлов

Файлы `.arb` (Application Resource Bundle) используются для хранения переводов в формате JSON. Каждый такой файл соответствует отдельному языку и содержит пары ключ–значение, где ключ — это идентификатор строки, а значение — перевод на соответствующем языке.

В рамках данной лабораторной работы в директории `assets/l10n` создаются два файла:

- `locale_en.arb` — содержит строки для английской локали;
- `locale_ru.arb` — содержит строки для русской локали (также используется как шаблон).

Файлы локализации создаются на основе ранее использовавшихся в приложении текстовых констант. Все такие строки, заданные напрямую через `Text('...')`, выносятся в `.arb`-файлы, где каждой из них присваивается уникальный ключ. Затем эти строки будут заменены обращениями к локализованным значениям, получаемым из сгенерированного класса `AppLocalizations`.

Это позволяет централизованно управлять переводами, избавляет от "жёстко заданных" текстов в коде и упрощает дальнейшее добавление новых языков без необходимости проходить весь проект вручную.

Пример содержимого файла `locale_ru.arb`:

```json
{
  "login": "Войти",
  "logout": "Выйти",
  "currencyRate": "Курс Валют",
  "news": "Новости",
  "profile": "Профиль",
  "theme": "Тема",
  "light": "Светлая",
  "dark": "Тёмная",
  "system": "Системная",
  "search": "Поиск",
  "asNominal": "({value} шт.)"
}
```

Файл `locale_en.arb` должен содержать те же ключи, но с переводами на английский язык:

```json
{
  "login": "Login",
  "logout": "Logout",
  "currencyRate": "Exchange Rate",
  "news": "News",
  "profile": "Profile",
  "theme": "Theme",
  "light": "Light",
  "dark": "Dark",
  "system": "System",
  "search": "Search",
  "asNominal": "({value} pcs.)"
}
```

> ⚠️ Важно: структура всех `.arb`-файлов должна совпадать по ключам, иначе генератор выдаст ошибку. Русский файл (`locale_ru.arb`) используется в качестве шаблона, от которого зависит структура остальных локалей.

#### Генерация файлов локализации

После запуска команды `flutter pub get` (при условии, что в `pubspec.yaml` указано `generate: true`) и при наличии корректного файла `l10n.yaml`, Flutter автоматически сгенерирует файлы локализации. В директории `lib/app/gen/l10n` появится:

- `app_localizations.dart` — основной файл с методами для доступа к строкам;
- `app_localizations_<locale>.dart` — вспомогательные файлы, соответствующие каждой локали.

Обращение к локализованным строкам в коде будет происходить через класс `AppLocalizations`, определённый в этих файлах.

### Использование barrel-файлов

`Barrel-файл` — это обычный `.dart`-файл, содержащий только экспорты других файлов. Он упрощает импорт зависимостей в разных частях проекта, позволяя заменить несколько строк `import` одной.

Например, у нас есть сгенерированные файлы локализации, размещённые в директории `l10n`. Без использования `barrel-файла` для их подключения пришлось бы явно импортировать каждый файл:

```dart
import 'l10n.dart';
import 'app_localizations_en.dart';
import 'app_localizations_ru.dart';
```

Чтобы избежать дублирования и упростить структуру, можно создать файл `l10n.dart` в той же директории и прописать в нём следующие экспорты (то есть все файлы, которые должны быть доступны "извне"):

```dart
export 'app_localizations.dart';
export 'app_localizations_en.dart';
export 'app_localizations_ru.dart';
```

После этого весь необходимый функционал будет доступен через один импорт:

```dart
import 'l10n.dart';
```

Если подобный пример кажется неубедительным, то в рамках внедрения `barrel-файлов` количество импортов для `main.dart` сократилось с 24 до 5!

Такой подход особенно полезен при работе с модулями, где требуется доступ сразу к нескольким связанным классам. Это делает структуру проекта более чистой и облегчает навигацию по коду.

> ⚠️ Важно: перед выполнением следующей части ЛР необходимо внедрить `barrel-файлы` в проект и заменить все избыточные импорты на созданные файлы.

### Внедрение локализации 

#### Добавление расширения

По аналогии с темой, цветами и шрифтами, добавим расширение, с помощью которого можно будет удобно обращаться к локализации. Для этого в файле `app/utils/context_ext.dart` добавим следующий код:

```dart
import 'package:mad_flutter_practicum/app/app.dart';

final _cachedLocale = AppLocalizationsRu();

extension ThemeContextExtension on BuildContext {
  AppLocalizations get loc => AppLocalizations.of(this) ?? _cachedLocale;
}
```

В редких случаях `AppLocalizations.of(context)` может вернуть `null` — например, при неправильной настройке локализации. Чтобы избежать сбоев, используется резервное значение `_cachedLocale`, содержащее строки по умолчанию.

##### Пример использования

Было:

```dart
Text('Курс Валют');
```

Стало:

```dart
Text(context.loc.currencyRate);
```

> ⚠️ Важно: согласно примеру, вам нужно заменить все жёстко-заданные текстовые значения во всем проекте на соответствующие строки, определённые в файлах локализации. Это позволит легко поддерживать многоязычность приложения и централизованно управлять текстами.

#### Настройка `main.dart`

Для корректной работы локализации необходимо указать соответствующие параметры в виджете `MaterialApp`:

- `locale: Locale('ru', 'RU')` — устанавливает локаль по умолчанию (в данном случае — русский);

- `localizationsDelegates: AppLocalizations.localizationsDelegates` — список делегатов, которые отвечают за загрузку локализованных ресурсов;

- `supportedLocales: AppLocalizations.supportedLocales` — список локалей, которые поддерживаются в приложении.

Эти настройки необходимы для интеграции системы локализации во всё приложение.

## 4. Самостоятельная часть

> Перед выполнением задания рекомендуется выбрать целевой уровень (оценку), что позволит определить глубину проработки и трудоёмкость реализации. Все уровни ориентированы на закрепление и расширение практических навыков работы с локализацией во Flutter.

### Задание на оценку "3"

- Реализовать `barrel-файлы` для всех директорий и заменить жёстко-заданные текстовые значения на локализованные во всем проекте.
- Добавить поддержку ещё одного языка. Выбор языка остаётся за вами
- Добавить в локализацию поддержку `plurals` (см глоссарий). Вместо простого числового значения (например, 60) на карточке валюты необходимо выводить текст с указанием единицы измерения, учитывая правила склонения.

### Задание на оценку "4"

Дополнительно к предыдущим требованиям:

- Реализовать форматирование даты в соответствии с текущей локалью на карточке новости с помощью [NumberFormatter](https://pub.dev/packages/intl).
  Например:  
  - для русской локали: `вт 16:59 29.07.25`  
  - для американской локали: `Tue 04:59 PM 07/29/25`
- Реализовать форматирование денежных значений в зависимости от текущей локали с помощью [DateFormatter](https://pub.dev/packages/intl#date-formatting-and-parsing).  
  Например:  
  - для русской локали: `1 234,56 ₽`  
  - для американской локали: `$1,234.56`
- Дополнительно освоить и применить **минимум 3 дополнительные функциональности** в рамках форматирования и локализации, предоставляемые пакетом `intl` и внедрить их в проект.

Для реализации форматирования дат и чисел также используйте возможности пакета [`intl`](https://pub.dev/packages/intl), который уже использовался в ранних ЛР.

> Важно: выбранные функциональности должны быть применимы к вашему проекту и отражаться в пользовательском интерфейсе и не должны, а также не должны повторять задание, которое встречалось ранее.

### Задание на оценку "5"

Дополнительно к предыдущим требованиям:

Реализовать возможность переключения языка приложения на экране профиля пользователя. Переключение должно происходить по аналогии с выбором темы оформления. Выбор пользователя должен сохраняться и применяться в том числе и при следующем запуске приложения.
